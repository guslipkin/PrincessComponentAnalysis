---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(data.table)
library(srt)
library(tidytext)
```


```{r}
# read in movie data
movieData <- fread("movieData.csv", na.strings = "")
movieData[sample(1:nrow(movieData), size = 6)]
```


```{r}
# read in subtitle files and create a `movie` column for identification
animated <- rbindlist(list(
  data.table(read_srt(path = "MovieSubtitles/Animated/Aladdin.srt", collapse = " "))[, movie := "Aladdin"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Beauty and the Beast.srt", collapse = " "))[, movie := "Beauty"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Brave.srt", collapse = " "))[, movie := "Brave"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Cinderella.srt", collapse = " "))[, movie := "Cinderella"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Moana.srt", collapse = " "))[, movie := "Moana"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Mulan.srt", collapse = " "))[, movie := "Mulan"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Pocahontas.srt", collapse = " "))[, movie := "Pocahontas"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Sleeping Beauty.srt", collapse = " "))[, movie := "Sleeping"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Snow White and The Seven Dwarfs.srt", collapse = " "))[, movie := "Snow"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Tangled.srt", collapse = " "))[, movie := "Tangled"],
  data.table(read_srt(path = "MovieSubtitles/Animated/The Little Mermaid.srt", collapse = " "))[, movie := "Mermaid"],
  data.table(read_srt(path = "MovieSubtitles/Animated/The Princess and the Frog.srt", collapse = " "))[, movie := "Frog"]))
animated[sample(1:nrow(animated), size = 6)]
```


```{r}
# get sentiments now so we don't have to keep doing it later
afinn <- get_sentiments("afinn")
bing <- get_sentiments("bing")
nrc <- get_sentiments("nrc")
```


```{r}
# generates longer data using each of the three dictionaries
# each word is on its own row
aniAfinnWordLonger <- animated %>%
  unnest_tokens(word, subtitle) %>%
  inner_join(afinn, by = "word")
aniAfinnWordLonger[sample(1:nrow(aniAfinnWordLonger), size = 6)]

aniBingWordLonger <- animated %>%
  unnest_tokens(word, subtitle) %>%
  inner_join(bing, by = "word")
aniBingWordLonger[sample(1:nrow(aniBingWordLonger), size = 6)]

# in this case, words can be repeated if they have more than one sentiment
aniNrcWordLonger <- animated %>%
  unnest_tokens(word, subtitle) %>%
  inner_join(nrc, by = "word")
aniNrcWordLonger[sample(1:nrow(aniNrcWordLonger), size = 6)]
  
# this version is .001 seconds slower...
# aniNrcLineWider <- aniNrcWordLonger[, groupID := .GRP, by = list(n, movie)] %>%
#   unique() %>%
#   select(-c(word)) %>%
#   pivot_wider(names_from = sentiment, values_from = 1, values_fn = length) %>%
#   arrange(movie, start) %>%
#   mutate(across(unique(nrc$sentiment), ~ifelse(is.na(.x), FALSE, TRUE))) %>%
#   data.table()
# aniNrcLineWider[sample(1:nrow(aniNrcLineWider), size = 6)]

# creates a wider version of aniNrcWordLonger, but aggregates by line
# lines are identified with a `groupID` found by grouping by line number and movie
aniNrcLineWider <- aniNrcWordLonger[, groupID := .GRP, by = list(n, movie)] %>%
  unique() %>%
  .[, !c("word")] %>%
  pivot_wider(names_from = sentiment, values_from = 1, values_fn = length) %>%
  setorderv(c("movie", "start")) %>%
  mutate(across(unique(nrc$sentiment), ~ifelse(is.na(.x), FALSE, TRUE))) %>%
  data.table()
aniNrcLineWider[sample(1:nrow(aniNrcLineWider), size = 6)]

# I spent so much time on this but made it better above :(
# it also showcases the some of the tidyverse version of the nonsense above
# %>%
#   left_join(aniNrcWordLonger %>%
#               group_by(n, movie) %>%
#               mutate(groupID = cur_group_id()) %>%
#               select(-c(n, word, sentiment)) %>%
#               unique(),
#             by = "groupID") %>%
#   select(movie, n, start, end, unique(nrc$sentiment)) %>%
#   arrange(movie, n)
```


```{r}
# gets sentiment scores for each movie

# adds up all the individual sentiments for each movie
aniAfinnWordLonger %>%
  group_by(movie) %>%
  summarise(totalSentiment = sum(value)) %>%
  arrange(desc(totalSentiment))

# gets sentiments, counts the number of positive and negative per movie,
#   then gets a total by finding the difference
aniBingWordLonger %>%
  group_by(movie) %>%
  count(sentiment) %>%
  pivot_wider(names_from = sentiment, id_cols = c("movie", "n"), values_from = n) %>%
  mutate(totalSentiment = positive - negative) %>%
  arrange(desc(totalSentiment))

# counts the number of each sentiment in each movie
# also creates a new column that finds the difference between `negative` and `positive`
#   and adds up the total number of sentiments (not including `negative` and `positive` 
#   to create `totalFeeling`
aniNrcWordLonger %>%
  group_by(movie) %>%
  count(sentiment) %>%
  arrange(movie, sentiment) %>%
  pivot_wider(names_from = sentiment, id_cols = c("movie", "n"), values_from = n) %>%
  mutate(totalSentiment = positive - negative) %>%
  rowwise() %>%
  mutate(totalFeeling = sum(c_across(c(2:6, 9:11)))) %>%
  arrange(desc(totalFeeling))
```

