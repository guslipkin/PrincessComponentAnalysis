---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(ggridges)
library(data.table)
library(srt)
library(tidytext)
library(fmsb)
```


```{r}
# read in movie data
movieData <- fread("movieData.csv", na.strings = "")[, movie := as.factor(movie)]
movieData[sample(1:nrow(movieData), size = 6)]

# set movie colors
movieColors <- c("Aladdin" = "steelblue1",
                 "Beauty" = "gold1",
                 "Brave" = "darkorange1",
                 "Cinderella" = "skyblue1",
                 "Frog" = "olivedrab2",
                 "Mermaid" = "aquamarine1",
                 "Moana" = "cyan2",
                 "Mulan" = "firebrick3",
                 "Pocahontas" = "burlywood",
                 "Sleeping" = "palevioletred1",
                 "Snow" = "red2",
                 "Tangled" = "mediumorchid1")
```


```{r}
# read in subtitle files and create a `movie` column for identification
animated <- rbindlist(list(
  data.table(read_srt(path = "MovieSubtitles/Animated/Aladdin.srt", collapse = " "))[, movie := "Aladdin"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Beauty and the Beast.srt", collapse = " "))[, movie := "Beauty"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Brave.srt", collapse = " "))[, movie := "Brave"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Cinderella.srt", collapse = " "))[, movie := "Cinderella"],
  data.table(read_srt(path = "MovieSubtitles/Animated/The Princess and the Frog.srt", collapse = " "))[, movie := "Frog"],
  data.table(read_srt(path = "MovieSubtitles/Animated/The Little Mermaid.srt", collapse = " "))[, movie := "Mermaid"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Moana.srt", collapse = " "))[, movie := "Moana"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Mulan.srt", collapse = " "))[, movie := "Mulan"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Pocahontas.srt", collapse = " "))[, movie := "Pocahontas"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Sleeping Beauty.srt", collapse = " "))[, movie := "Sleeping"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Snow White and The Seven Dwarfs.srt", collapse = " "))[, movie := "Snow"],
  data.table(read_srt(path = "MovieSubtitles/Animated/Tangled.srt", collapse = " "))[, movie := "Tangled"]))
animated[sample(1:nrow(animated), size = 6)]
```


```{r}
# Re-scale the time code so that we can compare rise and fall of the movie
rescale <- function(x){(x-min(x))/(max(x)-min(x))}
animated[, c("startScale", "endScale") := .(rescale(start), rescale(end)), by = movie]

# Create a `song` column and set it to False
animated[, song := FALSE]

# Some movies have clearly marked lines that are in song
animated[movie %in% c("Aladdin", "Beauty", "Sleeping", "Mermaid"), 
         song := grepl("(<\\/?i>)|(♫)|(\\{\\\\i1?\\})", 
                       subtitle)][
           , subtitle := gsub("(<\\/?i>)|(♫)|(\\[Singing\\])|(\\{\\\\i1?\\})", 
                              "", 
                              subtitle)]



# Brave lines are not in song
animated[movie %in% c("Brave", "Tangled"), 
         subtitle := gsub("(<i>)|(<\\/i>)|(♫)", 
                          "", 
                          subtitle)]

# These lines are in song
animated[movie == "Cinderella" & 
           n %in% c(54:66, 312:332, 432:452, 479:486, 488, 492:494, 545:546, 548, 
                    550, 552:553, 583:599, 662:667, 723:737, 1034:1038), 
         song := TRUE]
animated[movie == "Moana" & 
           n %in% c(75:121, 315:329, 504:566, 231:271, 872:892, 900:941, 
                    1136:1159, 1190:1196), 
         song := TRUE]
animated[movie == "Mulan" & 
           n %in% c(52:55,  58:61, 65:85, 89:107, 133:154, 449:492 ,585:618, 
                    760:764), 
         song := TRUE]

# set the movie column to be a factor
animated[,movie := factor(movie, levels=names(sort(table(movie), decreasing = TRUE)))]

# Sample some lines to see the changes
animated[][sample(1:.N, size = 6)]
```


```{r}
# get sentiments now so we don't have to keep doing it later
afinn <- get_sentiments("afinn")
bing <- get_sentiments("bing")
nrc <- get_sentiments("nrc")
```


```{r}
# generates longer data using each of the three dictionaries
# each word is on its own row
aniAfinnWordLonger <- animated %>%
  unnest_tokens(word, subtitle) %>%
  inner_join(afinn, by = "word")
aniAfinnWordLonger[sample(1:nrow(aniAfinnWordLonger), size = 6)]

aniBingWordLonger <- animated %>%
  unnest_tokens(word, subtitle) %>%
  inner_join(bing, by = "word")
aniBingWordLonger[sample(1:nrow(aniBingWordLonger), size = 6)]

# in this case, words can be repeated if they have more than one sentiment
aniNrcWordLonger <- animated %>%
  unnest_tokens(word, subtitle) %>%
  inner_join(nrc, by = "word")
aniNrcWordLonger[sample(1:nrow(aniNrcWordLonger), size = 6)]
  
# this version is .001 seconds slower...
# aniNrcLineWider <- aniNrcWordLonger[, groupID := .GRP, by = list(n, movie)] %>%
#   unique() %>%
#   select(-c(word)) %>%
#   pivot_wider(names_from = sentiment, values_from = 1, values_fn = length) %>%
#   arrange(movie, start) %>%
#   mutate(across(unique(nrc$sentiment), ~ifelse(is.na(.x), FALSE, TRUE))) %>%
#   data.table()
# aniNrcLineWider[sample(1:nrow(aniNrcLineWider), size = 6)]

# creates a wider version of aniNrcWordLonger, but aggregates by line
# lines are identified with a `groupID` found by grouping by line number and movie
aniNrcLineWider <- aniNrcWordLonger[, groupID := .GRP, by = list(n, movie)] %>%
  unique() %>%
  .[, !c("word")] %>%
  pivot_wider(names_from = sentiment, values_from = 1, values_fn = length) %>%
  setorderv(c("movie", "start")) %>%
  mutate(across(unique(nrc$sentiment), ~ifelse(is.na(.x), FALSE, TRUE))) %>%
  data.table()
aniNrcLineWider[sample(1:nrow(aniNrcLineWider), size = 6)]
# I spent so much time on this but made it better above :(
# it also showcases the some of the tidyverse version of the nonsense above
# %>%
#   left_join(aniNrcWordLonger %>%
#               group_by(n, movie) %>%
#               mutate(groupID = cur_group_id()) %>%
#               select(-c(n, word, sentiment)) %>%
#               unique(),
#             by = "groupID") %>%
#   select(movie, n, start, end, unique(nrc$sentiment)) %>%
#   arrange(movie, n)
```

```{r}
tmp <- aniNrcWordLonger[, groupID := .GRP, by = list(n, movie)] %>%
  unique() %>%
  .[, !c("word")] %>%
  pivot_wider(names_from = sentiment, values_from = 1, values_fn = length) %>%
  rowwise(groupID) %>%
  mutate(totalFeeling = sum(c_across(unique(nrc$sentiment)), na.rm = TRUE)) %>%
  ungroup() %>%
  select(startScale, movie, totalFeeling) %>%
  group_by(startScale, movie) %>%
  summarise(rep = seq(1, totalFeeling, 1)) %>%
  arrange(movie) %>%
  mutate(movie = factor(movie, levels = rev(movieData$movie)),
         movColors = movieColors[movie])
tmp %>%
  ggplot() +
  geom_density_ridges(aes(x = startScale, y = movie, fill = movie), 
                      color = "black") +
  scale_fill_manual(values = tmp$movColors[order(tmp$movie)]) +
  theme_ridges() +
  xlim(0, 1) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "NRC emotions over the course of the movie")

rm(test)
```


```{r}
# by line
tmp <- aniAfinnWordLonger[, groupID := .GRP, by = list(n, movie)] %>%
  group_by(movie, song, groupID) %>%
  summarise(value = sum(value)) %>%
  arrange(movie) %>%
  mutate(movie = factor(movie, levels = movieData$movie),
         movColors = movieColors[movie],
         songColors = ifelse(song, "black", "white"),
         song = ifelse(song, "Sung", "Spoken")) %>%
  select(movie, value, song, movColors, songColors) 
tmp %>%
  ggplot() +
  geom_violin(aes(x = song, y = value, linetype = song, fill = movie), position = "dodge") + 
  ylim(min(tmp$value), max(tmp$value)) +
  # ylim(-9, 9) +
  geom_hline(yintercept = 0, size = .5) +
  labs(title = "Variation in positive and negative emotions of lines by type") +
  theme(legend.position = "none") +
  facet_wrap(~movie) +
  scale_fill_manual(values = tmp$movColors[order(tmp$movie)])

# by word
tmp <- aniAfinnWordLonger %>%
  arrange(movie) %>%
  mutate(movie = factor(movie, levels = movieData$movie),
         movColors = movieColors[movie],
         songColors = ifelse(song, "black", "white"),
         song = ifelse(song, "Sung", "Spoken")) %>%
  select(movie, value, song, movColors, songColors)
tmp %>%
  ggplot() +
  geom_violin(aes(x = song, y = value, linetype = song, fill = movie), position = "dodge") + 
  ylim(-5, 5) +
  geom_hline(yintercept = 0, size = .5) +
  labs(title = "Variation in positive and negative emotions of words by type") +
  theme(legend.position = "none") +
  facet_wrap(~movie) +
  scale_fill_manual(values = tmp$movColors[order(tmp$movie)])
```


```{r}
# gets sentiment scores for each movie

# adds up all the individual sentiments for each movie
aniAfinnWordLonger %>%
  group_by(movie) %>%
  summarise(totalSentiment = sum(value)) %>%
  arrange(desc(totalSentiment))

# gets sentiments, counts the number of positive and negative per movie,
#   then gets a total by finding the difference
aniBingWordLonger %>%
  group_by(movie) %>%
  count(sentiment) %>%
  pivot_wider(names_from = sentiment, id_cols = c("movie", "n"), values_from = n) %>%
  mutate(totalSentiment = positive - negative) %>%
  arrange(desc(totalSentiment))

# counts the number of each sentiment in each movie
# also creates a new column that finds the difference between `negative` and `positive`
#   and adds up the total number of sentiments (not including `negative` and `positive` 
#   to create `totalFeeling`
aniNrcMovieWider <- aniNrcWordLonger %>%
  group_by(movie) %>%
  count(sentiment) %>%
  arrange(movie, sentiment) %>%
  pivot_wider(names_from = sentiment, id_cols = c("movie", "n"), values_from = n) %>%
  mutate(totalSentiment = positive - negative) %>%
  rowwise() %>%
  mutate(totalFeeling = sum(c_across(c(2:6, 9:11)))) %>%
  arrange(desc(totalFeeling)) %>%
  data.table()
aniNrcMovieWider
```


```{r}
transpose(data.table(sentiment = unique(nrc$sentiment), 
                     max = max(aniNrcMovieWider %>% select(unique(nrc$sentiment))),
                     min = min(aniNrcMovieWider %>% select(unique(nrc$sentiment)))), 
          make.names = "sentiment") %>%
  rbind(aniNrcMovieWider %>% select(unique(nrc$sentiment))) %>%
  `rownames<-`(c("max", "min", aniNrcMovieWider$movie)) %>%
  radarchart()
```

